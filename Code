#include <Wire.h>
#include <WiFi.h>
#include <WebServer.h>
#include <WebSocketsServer.h>
#include "FastIMU.h"

// ==========================================
// ‚ö†Ô∏è USER CONFIGURATION - EDIT THIS! ‚ö†Ô∏è
// ==========================================
const char* ssid = "YOUR_WIFI_NAME";      // <--- PUT YOUR WIFI NAME HERE
const char* password = "YOUR_WIFI_PASSWORD"; // <--- PUT YOUR PASSWORD HERE
// ==========================================

// Pins
#define I2C_SDA 21
#define I2C_SCL 22
#define BUZZER_PIN 25

// MPU6500
#define IMU_ADDRESS 0x68
MPU6500 mpu;
calData calib = { 0 };
AccelData accelData;
GyroData gyroData;

WebServer server(80);
WebSocketsServer webSocket = WebSocketsServer(81);

// Motion data
float accelX, accelY, accelZ;
float gyroX, gyroY, gyroZ;
float roll, pitch;
float accelMag, gyroMag;

// String states
bool stringActive[6] = {false};
float stringVelocity[6] = {0};
int activeStringCount = 0;

// Guitar type (0=Acoustic, 1=Electric, 2=Classical, 3=Bass, 4=Ukulele)
int currentGuitarType = 0;
int stringCount = 6;

// Tunings for different guitars (Hz)
const float tunings[5][6] = {
  {82.41, 110.00, 146.83, 196.00, 246.94, 329.63},  // Acoustic
  {82.41, 110.00, 146.83, 196.00, 246.94, 329.63},  // Electric
  {82.41, 110.00, 146.83, 196.00, 246.94, 329.63},  // Classical
  {41.20, 55.00, 73.42, 98.00, 0, 0},               // Bass (4 strings)
  {392.00, 261.63, 329.63, 440.00, 0, 0}            // Ukulele (4 strings)
};

// Chord data
String currentChord = "Open";
int currentChordIndex = 0;

// Chord fret patterns
int chordFrets[7][6] = {
  {0, 0, 0, 0, 0, 0},   // Open
  {0, 3, 2, 0, 1, 0},   // C
  {3, 2, 0, 0, 0, 3},   // G
  {-1, 0, 0, 2, 3, 2},  // D
  {0, 2, 2, 0, 0, 0},   // Em
  {0, 0, 2, 2, 1, 0},   // Am
  {-1, 0, 0, 2, 3, 1}   // Dm
};

// Sensitivity & Thresholds
float sensitivity = 1.0;
const float STRUM_THRESHOLD = 0.25;
const float GYRO_THRESHOLD = 25.0;
const unsigned long STRUM_COOLDOWN = 120;

// Timing
unsigned long lastStrumTime = 0;
unsigned long lastChordChange = 0;
unsigned long lastSensorUpdate = 0;
unsigned long lastBroadcast = 0;
float lastAccelMag = 1.0;
bool wasStrumming = false;

// Function Prototypes
void updateSensor();
void updateStringSelection();
void detectChord();
void broadcastData();
void webSocketEvent(uint8_t num, WStype_t type, uint8_t* payload, size_t length);

// ==========================================
// üé® ENGINEERING UI - HTML/CSS/JS
// ==========================================

const char webpage_part1[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Electric Brain: ENG-Grade</title>
<style>
:root {
    --bg: #050508;
    --panel: rgba(15, 15, 25, 0.7);
    --border: rgba(100, 200, 255, 0.15);
    --primary: #00f0ff;
    --secondary: #ff0055;
    --text: #c0c0d0;
    --grid: rgba(0, 240, 255, 0.03);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    background-color: var(--bg);
    background-image: 
        linear-gradient(var(--grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px);
    background-size: 30px 30px;
    color: var(--text);
    overflow-x: hidden;
    min-height: 100vh;
}
.app-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 10px;
}
/* --- Electric Brain Logo Animation --- */
.header-unit {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--panel);
    border: 1px solid var(--border);
    padding: 15px 25px;
    border-radius: 4px;
    backdrop-filter: blur(10px);
    margin-bottom: 20px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    position: relative;
    overflow: hidden;
}
.header-unit::before {
    content: ''; position: absolute; top:0; left:0; width: 4px; height: 100%;
    background: var(--primary); box-shadow: 0 0 10px var(--primary);
}
.brain-container {
    position: relative;
    width: 60px;
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
}
.brain-emoji { font-size: 30px; z-index: 2; filter: hue-rotate(180deg) brightness(1.5); }
.electron-ring {
    position: absolute; width: 100%; height: 100%;
    border-radius: 50%; border: 1px solid rgba(0, 240, 255, 0.3);
    animation: spin 2s linear infinite;
}
.electron-ring::after {
    content: ''; position: absolute; top: -3px; left: 50%;
    width: 6px; height: 6px; background: var(--primary);
    border-radius: 50%; box-shadow: 0 0 10px var(--primary);
}
.electron-ring:nth-child(2) { animation-duration: 3s; transform: rotate(45deg); width: 80%; height: 80%; border-color: rgba(255, 0, 85, 0.3); }
.electron-ring:nth-child(2)::after { background: var(--secondary); box-shadow: 0 0 10px var(--secondary); }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.title-block h1 { font-size: 1.5rem; color: #fff; letter-spacing: 2px; text-transform: uppercase; }
.title-block .sub { font-size: 0.7rem; color: var(--primary); }

.status-grid { display: flex; gap: 15px; font-size: 0.8rem; }
.status-item { display: flex; align-items: center; gap: 6px; }
.led { width: 8px; height: 8px; border-radius: 50%; background: #333; transition: all 0.3s; }
.led.on { background: #0f0; box-shadow: 0 0 8px #0f0; }
.led.warn { background: #ff0; box-shadow: 0 0 8px #ff0; }
.led.off { background: #f00; box-shadow: 0 0 8px #f00; }

/* --- Engineering Grid Layout --- */
.main-dashboard {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 15px;
}
@media (max-width: 900px) { .main-dashboard { grid-template-columns: 1fr; } }

.panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 15px;
    position: relative;
}
.panel-header {
    font-size: 0.8rem;
    color: var(--primary);
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
}

/* --- 3D Canvas --- */
#guitarCanvas {
    width: 100%;
    height: 400px;
    background: radial-gradient(circle at center, #1a1a2e 0%, #050508 100%);
    border-radius: 4px;
    border: 1px solid var(--border);
}

/* --- Controls & Metrics --- */
.metrics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
}
.metric-box {
    background: rgba(0,0,0,0.3);
    padding: 10px;
    border-left: 2px solid var(--secondary);
}
.metric-val { font-size: 1.4rem; color: #fff; font-weight: bold; }
.metric-label { font-size: 0.7rem; opacity: 0.7; }

.string-visualizer {
    display: flex;
    justify-content: space-between;
    height: 100px;
    margin: 15px 0;
    gap: 4px;
}
.eng-string {
    flex: 1;
    background: rgba(255,255,255,0.05);
    position: relative;
    border-radius: 2px;
    transition: 0.1s;
}
.eng-string.active { background: rgba(0, 240, 255, 0.2); box-shadow: 0 0 15px rgba(0, 240, 255, 0.1); }
.eng-string::after {
    content: attr(data-note);
    position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);
    font-size: 10px; color: #fff;
}
.eng-string .vibe-line {
    position: absolute; left: 50%; top: 0; bottom: 0; width: 2px;
    background: var(--text); transform: translateX(-50%);
}

.control-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(90deg, rgba(0,240,255,0.1), transparent);
    border: 1px solid var(--primary);
    color: var(--primary);
    font-family: inherit;
    text-transform: uppercase;
    cursor: pointer;
    transition: 0.2s;
    margin-top: 5px;
}
.control-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }

.graph-container {
    height: 80px;
    background: rgba(0,0,0,0.2);
    border-bottom: 1px solid var(--border);
    margin-bottom: 5px;
    position: relative;
}
.graph-canvas { width: 100%; height: 100%; display: block; }
</style>
</head>
<body>
<div class="app-container">
    
    <div class="header-unit">
        <div style="display:flex; align-items:center; gap:15px;">
            <div class="brain-container">
                <div class="electron-ring"></div>
                <div class="electron-ring"></div>
                <div class="brain-emoji">üß†</div>
            </div>
            <div class="title-block">
                <h1>Electric Brain</h1>
                <div class="sub">ENGINEERING GRADE PHYSICS ENGINE v5.0</div>
            </div>
        </div>
        <div class="status-grid">
            <div class="status-item"><div id="ws-led" class="led warn"></div><span id="ws-text">NET_INIT</span></div>
            <div class="status-item"><div id="audio-led" class="led off"></div><span>AUDIO_DRV</span></div>
            <div class="status-item">FPS: <span id="fps-counter">0</span></div>
        </div>
    </div>

    <div class="main-dashboard">
        <div class="panel">
            <div class="panel-header">
                <span>Real-Time Physics Rendering</span>
                <span>Active String: <span id="active-str-idx">NONE</span></span>
            </div>
            <canvas id="guitarCanvas"></canvas>
            <div style="margin-top:10px; font-size:0.8rem; color:var(--text); display:flex; gap:20px;">
                <span>ROLL: <span id="roll-val" style="color:var(--primary)">0.00¬∞</span></span>
                <span>PITCH: <span id="pitch-val" style="color:var(--secondary)">0.00¬∞</span></span>
                <span>ACCEL: <span id="acc-val">1.00g</span></span>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><span>Telemetry & Control</span></div>
            
            <div class="metrics-grid">
                <div class="metric-box">
                    <div class="metric-val" id="chord-disp">OPEN</div>
                    <div class="metric-label">CURRENT CHORD</div>
                </div>
                <div class="metric-box">
                    <div class="metric-val" id="strum-count">0</div>
                    <div class="metric-label">TOTAL STRUMS</div>
                </div>
            </div>

            <div class="string-visualizer" id="string-viz">
                </div>

            <div style="margin: 20px 0;">
                <div class="panel-header"><span>Signal Analysis (Gyro Z)</span></div>
                <div class="graph-container">
                    <canvas id="scopeCanvas"></canvas>
                </div>
            </div>

            <button class="control-btn" id="audio-btn" onclick="toggleAudio()">INITIALIZE AUDIO ENGINE</button>
            <div style="margin-top:10px;">
                 <label style="font-size:0.7rem;">INPUT SENSITIVITY</label>
                 <input type="range" style="width:100%" min="50" max="200" value="100" oninput="updateSens(this.value)">
            </div>
        </div>
    </div>
</div>
<script>
)rawliteral";

const char webpage_part2[] PROGMEM = R"rawliteral(
// ==========================================
// üß† ELECTRIC BRAIN - PHYSICS ENGINE (JS)
// ==========================================

// Global State
let ws;
let audioCtx;
let audioEnabled = false;
let lastFrameTime = 0;
let frameCount = 0;

// Physics State
const physics = {
    roll: 0,
    pitch: 0,
    strings: [0,0,0,0,0,0], // 0 = idle, 1 = vibrating
    stringActive: [false, false, false, false, false, false],
    decay: 0.92
};

// Scope Data
const scopeData = new Array(100).fill(0);

// Colors
const colors = ['#ff0055', '#ff5500', '#ffaa00', '#00ff55', '#00ccff', '#aa00ff'];

function init() {
    connectWS();
    initVisuals();
    renderLoop();
    setInterval(updateStats, 1000);
}

function connectWS() {
    const statusText = document.getElementById('ws-text');
    const led = document.getElementById('ws-led');
    
    statusText.innerText = "CONNECTING...";
    led.className = "led warn";

    // Attempt to connect to the hosting ESP32
    ws = new WebSocket('ws://' + window.location.hostname + ':81');

    ws.onopen = () => {
        statusText.innerText = "ONLINE";
        led.className = "led on";
        console.log("WS Connected");
    };

    ws.onclose = () => {
        statusText.innerText = "OFFLINE";
        led.className = "led off";
        setTimeout(connectWS, 2000);
    };

    ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        processTelemetry(data);
    };
}

function processTelemetry(data) {
    // Update Physics State
    physics.roll = data.roll || 0;
    physics.pitch = data.pitch || 0;
    
    // UI Updates
    document.getElementById('roll-val').innerText = physics.roll.toFixed(2) + '¬∞';
    document.getElementById('pitch-val').innerText = physics.pitch.toFixed(2) + '¬∞';
    document.getElementById('acc-val').innerText = (data.accelMag || 1).toFixed(2) + 'g';
    document.getElementById('chord-disp').innerText = data.chord || "OPEN";
    
    // Scope Update
    scopeData.push(data.gyroZ || 0);
    scopeData.shift();

    // String Logic
    let activeIdx = "NONE";
    for(let i=0; i<6; i++) {
        // Did state change to active?
        if (data.strings && data.strings[i] && !physics.stringActive[i]) {
            // Pluck physics
            physics.strings[i] = 1.0; 
        }
        physics.stringActive[i] = data.strings ? data.strings[i] : false;
        
        // Update DOM Indicators
        const el = document.getElementById('str-'+i);
        if(el) {
            if(physics.stringActive[i]) {
                el.classList.add('active');
                activeIdx = i + 1;
            } else {
                el.classList.remove('active');
            }
        }
    }
    document.getElementById('active-str-idx').innerText = activeIdx;

    // Strum Event
    if(data.strum) {
        document.getElementById('strum-count').innerText = parseInt(document.getElementById('strum-count').innerText) + 1;
        document.getElementById('chord-disp').style.color = "#00ff55";
        setTimeout(() => document.getElementById('chord-disp').style.color = "#fff", 100);
        
        // Trigger Audio
        if(audioEnabled && data.playFreqs) {
            data.playFreqs.forEach(f => {
                if(f > 0) playSynth(f);
            });
        }
        // Maximize vibration on strum
        for(let i=0; i<6; i++) {
            if(physics.stringActive[i]) physics.strings[i] = 1.5;
        }
    }
}

// ==========================================
// üîä AUDIO ENGINE
// ==========================================
function toggleAudio() {
    if(!audioEnabled) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioEnabled = true;
        document.getElementById('audio-btn').innerText = "AUDIO ENGINE ACTIVE";
        document.getElementById('audio-btn').style.background = "var(--primary)";
        document.getElementById('audio-btn').style.color = "#000";
        document.getElementById('audio-led').className = "led on";
        playSynth(440); // Test beep
    }
}

function playSynth(freq) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    
    osc.type = 'sawtooth';
    osc.frequency.value = freq;
    
    // Envelope
    gain.gain.setValueAtTime(0, audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
    
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.start();
    osc.stop(audioCtx.currentTime + 0.5);
}

function updateSens(val) {
    if(ws) ws.send(JSON.stringify({sensitivity: val/100}));
}

// ==========================================
// üñåÔ∏è RENDER ENGINE
// ==========================================
function initVisuals() {
    // Generate String Indicators
    const viz = document.getElementById('string-viz');
    const notes = ['E','A','D','G','B','E'];
    viz.innerHTML = '';
    for(let i=5; i>=0; i--) {
        viz.innerHTML += `<div class="eng-string" id="str-${i}" data-note="${notes[i]}"><div class="vibe-line"></div></div>`;
    }
}
)rawliteral";

const char webpage_part3[] PROGMEM = R"rawliteral(
function renderLoop() {
    const canvas = document.getElementById('guitarCanvas');
    const ctx = canvas.getContext('2d');
    const w = canvas.width = canvas.offsetWidth;
    const h = canvas.height = canvas.offsetHeight;
    const time = Date.now();

    // Clear
    ctx.clearRect(0,0,w,h);

    // --- 3D Perspective Math ---
    // Vanishing Point
    const vpX = w/2;
    const vpY = h * 0.2; 
    
    const neckWidthBottom = w * 0.6;
    const neckWidthTop = w * 0.15;
    const neckLen = h * 0.9;

    // Apply User Rotation (Roll) to the scene
    ctx.save();
    ctx.translate(w/2, h/2);
    ctx.rotate(physics.roll * Math.PI / 180);
    ctx.translate(-w/2, -h/2);

    // Draw Fretboard (Trapezoid for perspective)
    const grad = ctx.createLinearGradient(0, h, 0, 0);
    grad.addColorStop(0, '#2a2a3e');
    grad.addColorStop(1, '#000');
    
    ctx.fillStyle = grad;
    ctx.strokeStyle = 'var(--primary)';
    ctx.lineWidth = 2;

    ctx.beginPath();
    ctx.moveTo((w - neckWidthBottom)/2, h); // Bottom Left
    ctx.lineTo((w + neckWidthBottom)/2, h); // Bottom Right
    ctx.lineTo((w + neckWidthTop)/2, vpY);  // Top Right
    ctx.lineTo((w - neckWidthTop)/2, vpY);  // Top Left
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    // Draw Frets
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 1;
    for(let i=0; i<12; i++) {
        // Exponential spacing for frets
        const y = h - (h - vpY) * (1 - Math.pow(0.94, i*1.5)); 
        // Interpolate width at this Y
        const progress = (y - vpY) / (h - vpY);
        const currentWidth = neckWidthTop + (neckWidthBottom - neckWidthTop) * progress;
        
        ctx.beginPath();
        ctx.moveTo((w - currentWidth)/2, y);
        ctx.lineTo((w + currentWidth)/2, y);
        ctx.stroke();
    }

    // Draw Strings with Physics
    for(let i=0; i<6; i++) {
        // Calculate X positions for this string
        const strOffset = i / 5; // 0 to 1
        
        // Bottom X
        const bX = (w - neckWidthBottom)/2 + 20 + (neckWidthBottom - 40) * strOffset;
        // Top X
        const tX = (w - neckWidthTop)/2 + 5 + (neckWidthTop - 10) * strOffset;

        // Vibration Amplitude
        let amp = 0;
        if(physics.strings[i] > 0.01) {
            amp = Math.sin(time * 0.1 + i) * physics.strings[i] * 10;
            physics.strings[i] *= physics.decay; // Decay energy
        }

        ctx.strokeStyle = physics.stringActive[i] ? colors[i] : 'rgba(200,200,200,0.5)';
        ctx.lineWidth = physics.stringActive[i] ? 3 : 1 + (i*0.3);
        ctx.shadowBlur = physics.stringActive[i] ? 15 : 0;
        ctx.shadowColor = colors[i];

        ctx.beginPath();
        ctx.moveTo(bX + amp, h);
        ctx.lineTo(tX, vpY);
        ctx.stroke();
        ctx.shadowBlur = 0;
    }

    ctx.restore(); // Restore Rotation

    // Draw Scope (Gyro Z)
    drawScope();

    frameCount++;
    requestAnimationFrame(renderLoop);
}

function drawScope() {
    const canvas = document.getElementById('scopeCanvas');
    const ctx = canvas.getContext('2d');
    const w = canvas.width = canvas.offsetWidth;
    const h = canvas.height = canvas.offsetHeight;

    ctx.strokeStyle = 'var(--secondary)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    for(let i=0; i<scopeData.length; i++) {
        const x = (i / scopeData.length) * w;
        // Normalize roughly -250 to 250 range to height
        const y = h/2 + (scopeData[i] / 500) * h;
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    }
    ctx.stroke();
}

function updateStats() {
    document.getElementById('fps-counter').innerText = frameCount;
    frameCount = 0;
}

window.onload = init;
</script>
</body>
</html>
)rawliteral";

// ==========================================
// üì° ESP32 BACKEND LOGIC
// ==========================================

void webSocketEvent(uint8_t num, WStype_t type, uint8_t* payload, size_t length) {
  if (type == WStype_TEXT) {
    String msg = String((char*)payload);
    if (msg.indexOf("sensitivity") > 0) {
      int idx = msg.indexOf(":");
      if (idx > 0) {
        sensitivity = msg.substring(idx + 1).toFloat();
        Serial.printf("üéöÔ∏è Sensitivity set to: %.2f\n", sensitivity);
      }
    }
  }
}

void setup() {
  Serial.begin(115200);
  delay(500);
  
  // Audio Setup (Core 3.0 Compatible)
  ledcAttach(BUZZER_PIN, 1000, 8);
  
  // IMU Setup
  Wire.begin(I2C_SDA, I2C_SCL);
  Wire.setClock(400000);
  int err = mpu.init(calib, IMU_ADDRESS);
  if (err != 0) {
    Serial.printf("Error MPU6500: %d\n", err);
    while (1) delay(100);
  }
  mpu.setAccelRange(4);
  mpu.setGyroRange(500);
  
  // WiFi Setup
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  
  // ‚ö†Ô∏è IMPORTANT: PRINT IP FOR USER ‚ö†Ô∏è
  Serial.println("\n=============================================");
  Serial.print("‚úÖ CONNECTED! IP ADDRESS: ");
  Serial.println(WiFi.localIP());
  Serial.println("=============================================");

  // Start Services
  webSocket.begin();
  webSocket.onEvent(webSocketEvent);
  
  server.on("/", []() {
    String fullPage = String(webpage_part1) + String(webpage_part2) + String(webpage_part3);
    server.send(200, "text/html", fullPage);
  });
  server.begin();
}

void loop() {
  webSocket.loop();
  server.handleClient();
  
  unsigned long now = millis();
  
  // Sensor Loop (approx 125Hz)
  if (now - lastSensorUpdate >= 8) {
    lastSensorUpdate = now;
    updateSensor();
  }
  
  // Broadcast Loop (approx 40Hz)
  if (now - lastBroadcast >= 25) {
    lastBroadcast = now;
    broadcastData();
  }
}

void updateSensor() {
  mpu.update();
  mpu.getAccel(&accelData);
  mpu.getGyro(&gyroData);
  
  accelX = accelData.accelX;
  accelY = accelData.accelY;
  accelZ = accelData.accelZ;
  gyroX = gyroData.gyroX;
  gyroY = gyroData.gyroY;
  gyroZ = gyroData.gyroZ;
  
  // Calculate Orientation
  roll = atan2(accelX, accelZ) * 180.0 / PI;
  pitch = atan2(accelY, sqrt(accelX * accelX + accelZ * accelZ)) * 180.0 / PI;
  
  accelMag = sqrt(accelX * accelX + accelY * accelY + accelZ * accelZ);
  gyroMag = sqrt(gyroX * gyroX + gyroY * gyroY + gyroZ * gyroZ);
  
  updateStringSelection();
  detectChord();
}

void updateStringSelection() {
  // Reset states
  for (int i = 0; i < 6; i++) {
    stringActive[i] = false;
  }
  
  // Map Roll angle to strings (Simple linear mapping for stability)
  float rollLimit = 45.0; 
  float val = constrain(roll, -rollLimit, rollLimit);
  // Map -45 to 45 -> 0 to 5
  int targetStr = map((long)val, -rollLimit, rollLimit, 0, 5);
  
  // Logic: Highlight the target string and maybe neighbors if roll is fast
  stringActive[targetStr] = true;
  
  // If moving fast (roll shake), activate neighbors
  if (abs(roll) > 10) {
      if(targetStr > 0) stringActive[targetStr-1] = true;
      if(targetStr < 5) stringActive[targetStr+1] = true;
  }
}

void detectChord() {
  unsigned long now = millis();
  if (now - lastChordChange < 150) return;
  
  String newChord = currentChord;
  
  // Simple Chord Logic based on Pitch (Tilting neck up/down)
  if (pitch > 35) newChord = "G Major";
  else if (pitch < -35) newChord = "D Major";
  else if (pitch > 15) newChord = "C Major";
  else if (pitch < -15) newChord = "A Minor";
  else newChord = "Open E";
  
  if (newChord != currentChord) {
    currentChord = newChord;
    lastChordChange = now;
    // Map chord string logic here if needed
  }
}

void broadcastData() {
  unsigned long now = millis();
  
  // Strum Detection
  float accelChange = abs(accelMag - lastAccelMag);
  lastAccelMag = accelMag;
  
  bool strum = false;
  // Threshold-based strumming
  if ((accelChange > STRUM_THRESHOLD * sensitivity) || (gyroMag > GYRO_THRESHOLD * sensitivity)) {
      if (now - lastStrumTime > STRUM_COOLDOWN) {
          strum = true;
          lastStrumTime = now;
      }
  }
  
  // Build JSON
  String json = "{";
  json += "\"roll\":" + String(roll, 2) + ",";
  json += "\"pitch\":" + String(pitch, 2) + ",";
  json += "\"accelMag\":" + String(accelMag, 2) + ",";
  json += "\"gyroZ\":" + String(gyroZ, 2) + ","; // For scope
  json += "\"chord\":\"" + currentChord + "\",";
  
  // Strings Array
  json += "\"strings\":[";
  for (int i = 0; i < 6; i++) {
    json += stringActive[i] ? "true" : "false";
    if (i < 5) json += ",";
  }
  json += "],";
  
  json += "\"strum\":" + String(strum ? "true" : "false");
  
  // Audio Frequencies (If strummed)
  if (strum) {
    json += ",\"playFreqs\":[";
    bool first = true;
    for(int i=0; i<6; i++) {
        if(stringActive[i]) {
            if(!first) json += ",";
            // Just sending base frequencies for now to keep logic simple
            json += String(tunings[0][i]); 
            first = false;
        }
    }
    json += "]";
    
    // Physical Feedback (Buzzer)
    ledcWriteTone(BUZZER_PIN, 200); // Click sound
    delay(10);
    ledcWriteTone(BUZZER_PIN, 0);
  }
  
  json += "}";
  webSocket.broadcastTXT(json);
}
