#include <Wire.h>
#include <WiFi.h>
#include <WebServer.h>
#include <WebSocketsServer.h>
#include "FastIMU.h"

// WiFi Credentials - CHANGE THESE!
const char* ssid = "22";
const char* password = "********";

// Pins
#define I2C_SDA 21
#define I2C_SCL 22
#define BUZZER_PIN 25

// MPU6500
#define IMU_ADDRESS 0x68
MPU6500 mpu;
calData calib = { 0 };
AccelData accelData;
GyroData gyroData;

WebServer server(80);
WebSocketsServer webSocket = WebSocketsServer(81);

// Motion data
float accelX, accelY, accelZ;
float gyroX, gyroY, gyroZ;
float roll, pitch;
float accelMag, gyroMag;

// String states
bool stringActive[6] = {false};
float stringVelocity[6] = {0};
int activeStringCount = 0;

// Guitar type (0=Acoustic, 1=Electric, 2=Classical, 3=Bass, 4=Ukulele)
int currentGuitarType = 0;
int stringCount = 6;

// Tunings for different guitars (Hz)
const float tunings[5][6] = {
  {82.41, 110.00, 146.83, 196.00, 246.94, 329.63},  // Acoustic
  {82.41, 110.00, 146.83, 196.00, 246.94, 329.63},  // Electric
  {82.41, 110.00, 146.83, 196.00, 246.94, 329.63},  // Classical
  {41.20, 55.00, 73.42, 98.00, 0, 0},               // Bass (4 strings)
  {392.00, 261.63, 329.63, 440.00, 0, 0}            // Ukulele (4 strings)
};

// Chord data
String currentChord = "Open";
int currentChordIndex = 0;

// Chord fret patterns
int chordFrets[7][6] = {
  {0, 0, 0, 0, 0, 0},   // Open
  {0, 3, 2, 0, 1, 0},   // C
  {3, 2, 0, 0, 0, 3},   // G
  {-1, 0, 0, 2, 3, 2},  // D
  {0, 2, 2, 0, 0, 0},   // Em
  {0, 0, 2, 2, 1, 0},   // Am
  {-1, 0, 0, 2, 3, 1}   // Dm
};

// Sensitivity
float sensitivity = 1.0;
const float STRUM_THRESHOLD = 0.25;
const float GYRO_THRESHOLD = 25.0;
const unsigned long STRUM_COOLDOWN = 120;

// Timing
unsigned long lastStrumTime = 0;
unsigned long lastChordChange = 0;
unsigned long lastSensorUpdate = 0;
unsigned long lastBroadcast = 0;
float lastAccelMag = 1.0;
bool wasStrumming = false;

// --- Function Prototypes ---
void updateSensor();
void updateStringSelection();
void detectChord();
void broadcastData();
void webSocketEvent(uint8_t num, WStype_t type, uint8_t* payload, size_t length);

// HTML/CSS/JavaScript Webpage - Part 1
const char webpage[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Electric Brain - ESP32 Guitar</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #0a1628 100%);
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
}
.container { max-width: 1600px; margin: 0 auto; padding: 12px; }
header {
  text-align: center;
  padding: 15px 0;
  border-bottom: 2px solid rgba(255,215,0,0.3);
  margin-bottom: 12px;
  background: rgba(0,0,0,0.3);
}
.branding {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  margin-bottom: 8px;
}
.logo {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: 0 4px 15px rgba(102,126,234,0.4);
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
  50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(102,126,234,0.6); }
}
h1 {
  font-size: 2.2em;
  background: linear-gradient(90deg, #ffd700, #ff6b6b, #4ecdc4, #ffd700);
  background-size: 300% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: shimmer 4s linear infinite;
}
.subtitle {
  font-size: 0.9em;
  color: #667eea;
  font-weight: 600;
  letter-spacing: 2px;
}
@keyframes shimmer { to { background-position: 300% center; } }
.status-bar {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 8px;
  flex-wrap: wrap;
  font-size: 0.85em;
}
.status-item { display: flex; align-items: center; gap: 5px; }
.dot { width: 8px; height: 8px; border-radius: 50%; }
.dot.green { background: #0f0; box-shadow: 0 0 8px #0f0; }
.dot.yellow { background: #ff0; box-shadow: 0 0 8px #ff0; }
.dot.red { background: #f00; box-shadow: 0 0 8px #f00; }
.guitar-selector {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.guitar-btn {
  background: rgba(255,255,255,0.1);
  border: 2px solid rgba(255,255,255,0.2);
  color: #fff;
  padding: 10px 20px;
  border-radius: 25px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.95em;
}
.guitar-btn:hover {
  background: rgba(255,255,255,0.2);
  transform: translateY(-2px);
}
.guitar-btn.active {
  background: linear-gradient(135deg, #ffd700, #ff8c00);
  border-color: #ffd700;
  color: #000;
  font-weight: bold;
  box-shadow: 0 4px 15px rgba(255,215,0,0.4);
}
.main-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 15px;
}
.graphs-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin-bottom: 15px;
}
.card {
  background: rgba(255,255,255,0.05);
  backdrop-filter: blur(10px);
  border-radius: 15px;
  padding: 15px;
  border: 1px solid rgba(255,255,255,0.1);
}
.card-title {
  font-size: 1em;
  color: #ffd700;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}
#guitarCanvas {
  width: 100%;
  height: 550px;
  display: block;
  border-radius: 10px;
  background: radial-gradient(ellipse at center, rgba(30,30,50,0.8) 0%, rgba(10,10,20,0.9) 100%);
}
.graph-canvas {
  width: 100%;
  height: 280px;
  display: block;
  border-radius: 8px;
  background: rgba(10,10,20,0.9);
  border: 1px solid rgba(100,126,234,0.3);
}
.graph-legend {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 8px;
  font-size: 0.75em;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
}
.legend-color {
  width: 20px;
  height: 3px;
  border-radius: 2px;
}
.demo-section {
  background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15));
  border: 2px solid rgba(102,126,234,0.4);
  border-radius: 12px;
  padding: 15px;
  margin: 12px 0;
}
.demo-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
}
.demo-btn {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border: none;
  color: white;
  padding: 10px 20px;
  border-radius: 20px;
  font-size: 0.95em;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 6px;
}
.demo-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(102,126,234,0.5);
}
.demo-btn.active {
  background: linear-gradient(135deg, #4ecdc4, #44a08d);
  box-shadow: 0 0 20px rgba(78,205,196,0.6);
}
.demo-instruction {
  background: rgba(0,0,0,0.4);
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  font-size: 0.9em;
  line-height: 1.6;
  margin-top: 10px;
  border-left: 4px solid #667eea;
}
.demo-step {
  background: rgba(102,126,234,0.1);
  padding: 8px 12px;
  border-radius: 6px;
  margin: 5px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}
.step-num {
  background: #667eea;
  color: white;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85em;
  font-weight: bold;
  flex-shrink: 0;
}
.strings-panel {
  display: flex;
  justify-content: center;
  gap: 6px;
  margin: 12px 0;
}
.string-ind {
  width: 45px;
  height: 90px;
  border-radius: 8px;
  background: rgba(0,0,0,0.4);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.1s;
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}
.string-ind::before {
  content: '';
  position: absolute;
  top: 0;
  left: 50%;
  width: 3px;
  height: 100%;
  background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0.4));
  transform: translateX(-50%);
  transition: all 0.1s;
}
.string-ind.active {
  border-color: var(--str-color, #ffd700);
  background: rgba(255,215,0,0.15);
  box-shadow: 0 0 15px var(--str-color, rgba(255,215,0,0.4));
}
.string-ind.active::before {
  animation: stringVibrate 0.05s infinite alternate;
  box-shadow: 0 0 10px var(--str-color, #ffd700);
}
@keyframes stringVibrate {
  from { transform: translateX(-50%) translateX(-2px); }
  to { transform: translateX(-50%) translateX(2px); }
}
.string-ind .note { font-size: 1.1em; font-weight: bold; z-index: 1; }
.string-ind .hz { font-size: 0.65em; opacity: 0.5; z-index: 1; }
.chord-display {
  text-align: center;
  padding: 15px 0;
}
.chord-name {
  font-size: 2.8em;
  font-weight: 800;
  background: linear-gradient(135deg, #ffd700, #ffed4e);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  transition: all 0.15s;
}
.chord-name.strumming {
  transform: scale(1.1);
  filter: brightness(1.3);
}
.guitar-type-label {
  font-size: 1em;
  opacity: 0.7;
  margin-top: 5px;
}
.audio-section {
  background: linear-gradient(135deg, rgba(255,100,100,0.1), rgba(255,150,100,0.1));
  border: 1px solid rgba(255,100,100,0.3);
  border-radius: 12px;
  padding: 15px;
  text-align: center;
  margin: 12px 0;
}
.audio-btn {
  background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
  border: none;
  color: white;
  padding: 12px 35px;
  border-radius: 25px;
  font-size: 1.1em;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.audio-btn:hover { transform: scale(1.05); box-shadow: 0 5px 20px rgba(255,100,100,0.4); }
.audio-btn.active { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-top: 12px;
}
.stat-box {
  background: rgba(0,0,0,0.3);
  padding: 10px 5px;
  border-radius: 8px;
  text-align: center;
}
.stat-val { font-size: 1.3em; font-weight: 700; color: #4ecdc4; font-family: monospace; }
.stat-lbl { font-size: 0.7em; opacity: 0.5; margin-top: 2px; }
.motion-section {
  margin-top: 12px;
}
.motion-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 8px 0;
}
.motion-label { width: 50px; font-size: 0.85em; }
.motion-bar {
  flex: 1;
  height: 12px;
  background: rgba(0,0,0,0.4);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
}
.motion-bar::before {
  content: '';
  position: absolute;
  left: 50%;
  top: 0;
  width: 2px;
  height: 100%;
  background: rgba(255,255,255,0.3);
}
.motion-fill {
  height: 100%;
  border-radius: 6px;
  transition: all 0.1s;
  position: absolute;
}
.motion-val { width: 60px; text-align: right; font-family: monospace; font-size: 0.85em; }
.sensitivity-section {
  margin-top: 12px;
  padding: 12px;
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
}
.sensitivity-section label { font-size: 0.9em; display: block; margin-bottom: 8px; }
input[type="range"] {
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: #333;
  -webkit-appearance: none;
  outline: none;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #ffd700;
  cursor: pointer;
}
.info-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.85);
  padding: 6px 15px;
  display: flex;
  justify-content: space-between;
  font-size: 0.8em;
  font-family: monospace;
}
@media (max-width: 1000px) {
  .main-grid { grid-template-columns: 1fr; }
  .graphs-grid { grid-template-columns: 1fr; }
  #guitarCanvas { height: 400px; }
  .graph-canvas { height: 220px; }
}
</style>
</head>
<body>
<div class="container">
<header>
<div class="branding">
<div class="logo">üß†</div>
<div>
<h1>Electric Brain</h1>
<div class="subtitle">ESP32 GUITAR SYSTEM</div>
</div>
</div>
<div class="status-bar">
<div class="status-item"><span class="dot green" id="wsDot"></span><span id="wsStatus">Connecting...</span></div>
<div class="status-item"><span class="dot yellow" id="audioDot"></span><span id="audioStatus">Audio Off</span></div>
<div class="status-item">üìä <span id="fps">0</span> FPS</div>
<div class="status-item">‚ö° <span id="latency">--</span>ms</div>
</div>
</header>
<div class="guitar-selector">
<button class="guitar-btn active" onclick="selectGuitar(0)">üé∏ Acoustic</button>
<button class="guitar-btn" onclick="selectGuitar(1)">‚ö° Electric</button>
<button class="guitar-btn" onclick="selectGuitar(2)">üéª Classical</button>
<button class="guitar-btn" onclick="selectGuitar(3)">üé∏ Bass</button>
<button class="guitar-btn" onclick="selectGuitar(4)">ü™ï Ukulele</button>
</div>
<div class="main-grid">
<div class="card">
<div class="card-title">üéÆ 3D Realistic Guitar - Motion Responsive</div>
<canvas id="guitarCanvas"></canvas>
</div>
<div class="card">
<div class="card-title">üéµ Control Panel</div>
<div class="strings-panel" id="stringsPanel">
  <div class="string-ind" id="s6" style="--str-color:#ff6b6b"><div class="note">E</div><div class="hz">82Hz</div></div>
  <div class="string-ind" id="s5" style="--str-color:#ffa502"><div class="note">A</div><div class="hz">110Hz</div></div>
  <div class="string-ind" id="s4" style="--str-color:#ffe66d"><div class="note">D</div><div class="hz">147Hz</div></div>
  <div class="string-ind" id="s3" style="--str-color:#7bed9f"><div class="note">G</div><div class="hz">196Hz</div></div>
  <div class="string-ind" id="s2" style="--str-color:#70a1ff"><div class="note">B</div><div class="hz">247Hz</div></div>
  <div class="string-ind" id="s1" style="--str-color:#a29bfe"><div class="note">E</div><div class="hz">330Hz</div></div>
</div>
<div class="chord-display">
<div class="chord-name" id="chordDisplay">Open</div>
<div class="guitar-type-label" id="guitarTypeLabel">Acoustic Guitar</div>
</div>
<div class="demo-section">
<div class="card-title">üìö Beginner Demo Mode</div>
<div class="demo-controls">
<button class="demo-btn" id="demoBtn" onclick="toggleDemo()"><span>‚ñ∂Ô∏è</span> Start Tutorial</button>
<button class="demo-btn" onclick="skipDemoStep()"><span>‚è≠Ô∏è</span> Next Step</button>
<button class="demo-btn" onclick="resetDemo()"><span>üîÑ</span> Reset</button>
</div>
<div class="demo-instruction" id="demoInstruction">Press "Start Tutorial" to learn how to play the air guitar!</div>
<div id="demoSteps" style="display:none; margin-top:10px;">
<div class="demo-step"><span class="step-num">1</span> Hold device horizontally like a guitar</div>
<div class="demo-step"><span class="step-num">2</span> Tilt left/right to select strings</div>
<div class="demo-step"><span class="step-num">3</span> Shake to strum and play</div>
<div class="demo-step"><span class="step-num">4</span> Tilt forward/back to change chords</div>
</div>
</div>
<div class="audio-section">
<button class="audio-btn" id="audioBtn" onclick="toggleAudio()"><span>üîä</span> TAP TO ENABLE SOUND</button>
</div>
<div class="stats-row">
<div class="stat-box"><div class="stat-val" id="strumCount">0</div><div class="stat-lbl">Strums</div></div>
<div class="stat-box"><div class="stat-val" id="noteCount">0</div><div class="stat-lbl">Notes</div></div>
<div class="stat-box"><div class="stat-val" id="activeCount">0</div><div class="stat-lbl">Strings</div></div>
<div class="stat-box"><div class="stat-val" id="accelVal">1.00</div><div class="stat-lbl">Accel G</div></div>
</div>
<div class="motion-section">
<div class="motion-row">
<span class="motion-label">Roll:</span>
<div class="motion-bar"><div class="motion-fill" id="rollFill" style="background:#ff6b6b;left:50%;width:0%;"></div></div>
<span class="motion-val" id="rollVal">0¬∞</span>
</div>
<div class="motion-row">
<span class="motion-label">Pitch:</span>
<div class="motion-bar"><div class="motion-fill" id="pitchFill" style="background:#4ecdc4;left:50%;width:0%;"></div></div>
<span class="motion-val" id="pitchVal">0¬∞</span>
</div>
<div class="motion-row">
<span class="motion-label">Strum:</span>
<div class="motion-bar"><div class="motion-fill" id="strumFill" style="background:#ffd700;left:0%;width:0%;"></div></div>
<span class="motion-val" id="strumVal">0%</span>
</div>
</div>
<div class="sensitivity-section">
<label>üéöÔ∏è Sensitivity: <span id="sensVal">100</span>%</label>
<input type="range" id="sensSlider" min="30" max="200" value="100" oninput="setSensitivity(this.value)">
</div>
</div>
</div>
<div class="card">
<div class="card-title">üìà Engineering Grade Motion Analysis</div>
</div>
<div class="graphs-grid">
<div class="card">
<div class="card-title">‚ö° Accelerometer X-Axis</div>
<canvas id="accelXGraph" class="graph-canvas"></canvas>
<div class="graph-legend">
<div class="legend-item"><div class="legend-color" style="background:#ff6b6b;"></div><span>Accel X</span></div>
<div class="legend-item"><div class="legend-color" style="background:#ffaa00;"></div><span>Avg</span></div>
</div>
</div>
<div class="card">
<div class="card-title">‚ö° Accelerometer Y-Axis</div>
<canvas id="accelYGraph" class="graph-canvas"></canvas>
<div class="graph-legend">
<div class="legend-item"><div class="legend-color" style="background:#4ecdc4;"></div><span>Accel Y</span></div>
<div class="legend-item"><div class="legend-color" style="background:#00d4ff;"></div><span>Avg</span></div>
</div>
</div>
<div class="card">
<div class="card-title">‚ö° Accelerometer Z-Axis</div>
<canvas id="accelZGraph" class="graph-canvas"></canvas>
<div class="graph-legend">
<div class="legend-item"><div class="legend-color" style="background:#a29bfe;"></div><span>Accel Z</span></div>
<div class="legend-item"><div class="legend-color" style="background:#d77fff;"></div><span>Avg</span></div>
</div>
</div>
<div class="card">
<div class="card-title">üîÑ Gyroscope X-Axis</div>
<canvas id="gyroXGraph" class="graph-canvas"></canvas>
<div class="graph-legend">
<div class="legend-item"><div class="legend-color" style="background:#ff6b6b;"></div><span>Gyro X</span></div>
<div class="legend-item"><div class="legend-color" style="background:#ff9999;"></div><span>Peak</span></div>
</div>
</div>
<div class="card">
<div class="card-title">üîÑ Gyroscope Y-Axis</div>
<canvas id="gyroYGraph" class="graph-canvas"></canvas>
<div class="graph-legend">
<div class="legend-item"><div class="legend-color" style="background:#4ecdc4;"></div><span>Gyro Y</span></div>
<div class="legend-item"><div class="legend-color" style="background:#7efff5;"></div><span>Peak</span></div>
</div>
</div>
<div class="card">
<div class="card-title">üîÑ Gyroscope Z-Axis</div>
<canvas id="gyroZGraph" class="graph-canvas"></canvas>
<div class="graph-legend">
<div class="legend-item"><div class="legend-color" style="background:#a29bfe;"></div><span>Gyro Z</span></div>
<div class="legend-item"><div class="legend-color" style="background:#c9bbff;"></div><span>Peak</span></div>
</div>
</div>
</div>
</div>
<div class="info-bar">
<span>¬© Electric Brain - Advanced Motion Sensing</span>
<span>Tilt ‚Üê ‚Üí to select | Shake to strum</span>
<span id="guitarInfo">6 strings | Standard E tuning</span>
</div>
<script>
)rawliteral";

const char webpage_part2[] PROGMEM = R"rawliteral(
const guitarTypes = [
  {
    name: 'Acoustic',
    label: 'Acoustic Guitar',
    strings: 6,
    tuning: ['E2','A2','D3','G3','B3','E4'],
    freqs: [82.41, 110.00, 146.83, 196.00, 246.94, 329.63],
    bodyColor: '#8B4513',
    bodyColor2: '#5D3A1A',
    neckColor: '#654321',
    soundHole: true,
    pickups: false,
    waveform: 'triangle',
    bodyShape: 'dreadnought'
  },
  {
    name: 'Electric',
    label: 'Electric Guitar',
    strings: 6,
    tuning: ['E2','A2','D3','G3','B3','E4'],
    freqs: [82.41, 110.00, 146.83, 196.00, 246.94, 329.63],
    bodyColor: '#1a1a2e',
    bodyColor2: '#0f0f1a',
    neckColor: '#3d2817',
    soundHole: false,
    pickups: true,
    waveform: 'sawtooth',
    bodyShape: 'stratocaster'
  },
  {
    name: 'Classical',
    label: 'Classical Guitar',
    strings: 6,
    tuning: ['E2','A2','D3','G3','B3','E4'],
    freqs: [82.41, 110.00, 146.83, 196.00, 246.94, 329.63],
    bodyColor: '#DEB887',
    bodyColor2: '#D2691E',
    neckColor: '#8B4513',
    soundHole: true,
    pickups: false,
    waveform: 'sine',
    bodyShape: 'classical'
  },
  {
    name: 'Bass',
    label: 'Bass Guitar',
    strings: 4,
    tuning: ['E1','A1','D2','G2'],
    freqs: [41.20, 55.00, 73.42, 98.00],
    bodyColor: '#2c2c54',
    bodyColor2: '#1a1a3a',
    neckColor: '#4a3728',
    soundHole: false,
    pickups: true,
    waveform: 'sine',
    bodyShape: 'precision'
  },
  {
    name: 'Ukulele',
    label: 'Ukulele',
    strings: 4,
    tuning: ['G4','C4','E4','A4'],
    freqs: [392.00, 261.63, 329.63, 440.00],
    bodyColor: '#DEB887',
    bodyColor2: '#CD853F',
    neckColor: '#8B4513',
    soundHole: true,
    pickups: false,
    waveform: 'triangle',
    bodyShape: 'ukulele'
  }
];

let currentGuitar = 0;
let stringCount = 6;
const stringColors = ['#ff6b6b', '#ffa502', '#ffe66d', '#7bed9f', '#70a1ff', '#a29bfe'];

let ws;
let audioEnabled = false;
let audioCtx;
let sensitivity = 1.0;

let roll = 0, pitch = 0;
let stringStates = [false, false, false, false, false, false];
let stringVibration = [0, 0, 0, 0, 0, 0];
let strumIntensity = 0;
let accelXRaw = 0, accelYRaw = 0, accelZRaw = 0;
let gyroXRaw = 0, gyroYRaw = 0, gyroZRaw = 0;

let strumCount = 0;
let noteCount = 0;
let frameCount = 0;
let updateCount = 0;
let lastFpsTime = Date.now();

// Missing variable definitions added here for safety
const vibSpeed = 0.05;
const vibAmp = 3.0;

let demoActive = false;
let demoStep = 0;
const demoInstructions = [
  "üé∏ Welcome! Hold your device horizontally like a guitar neck",
  "üëà Tilt LEFT slowly - watch the strings light up on the left side",
  "üëâ Now tilt RIGHT - see how different strings activate",
  "üìê Tilt FORWARD (pitch up) - this selects chord variations",
  "üìê Tilt BACKWARD (pitch down) - changes to different chords",
  "üí• Time to STRUM! Shake the device quickly to play the strings",
  "üéµ Try combining: Tilt to select strings, then shake to play!",
  "üéØ Practice Mode: Play the C chord (tilt forward 20-35¬∞) and strum",
  "üéØ Now try G chord (tilt forward >35¬∞) with a strong strum",
  "üéâ Excellent! You're ready to rock! Practice makes perfect!"
];

const GRAPH_BUFFER_SIZE = 150;
let accelXData = new Array(GRAPH_BUFFER_SIZE).fill(0);
let accelYData = new Array(GRAPH_BUFFER_SIZE).fill(0);
let accelZData = new Array(GRAPH_BUFFER_SIZE).fill(0);
let gyroXData = new Array(GRAPH_BUFFER_SIZE).fill(0);
let gyroYData = new Array(GRAPH_BUFFER_SIZE).fill(0);
let gyroZData = new Array(GRAPH_BUFFER_SIZE).fill(0);

function selectGuitar(idx) {
  currentGuitar = idx;
  const g = guitarTypes[idx];
  stringCount = g.strings;
  
  document.querySelectorAll('.guitar-btn').forEach((btn, i) => {
    btn.classList.toggle('active', i === idx);
  });
  
  document.getElementById('guitarTypeLabel').textContent = g.label;
  document.getElementById('guitarInfo').textContent = `${g.strings} strings | ${g.name} tuning`;
  
  const panel = document.getElementById('stringsPanel');
  panel.innerHTML = '';
  
  for (let i = 0; i < g.strings; i++) {
    const div = document.createElement('div');
    div.className = 'string-ind';
    div.id = 's' + (g.strings - i);
    div.style.setProperty('--str-color', stringColors[i % 6]);
    div.innerHTML = `<div class="note">${g.tuning[i]}</div><div class="hz">${Math.round(g.freqs[i])}Hz</div>`;
    panel.appendChild(div);
  }
  
  stringStates = new Array(6).fill(false);
  stringVibration = new Array(6).fill(0);
  
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({guitarType: idx}));
  }
}

function connectWS() {
  ws = new WebSocket('ws://' + location.hostname + ':81');
  
  ws.onopen = () => {
    document.getElementById('wsDot').className = 'dot green';
    document.getElementById('wsStatus').textContent = 'Connected';
  };
  
  ws.onclose = () => {
    document.getElementById('wsDot').className = 'dot red';
    document.getElementById('wsStatus').textContent = 'Reconnecting...';
    setTimeout(connectWS, 1500);
  };
  
  ws.onmessage = (e) => {
    const t0 = performance.now();
    try {
      processData(JSON.parse(e.data));
      document.getElementById('latency').textContent = (performance.now() - t0).toFixed(1);
      updateCount++;
    } catch(err) { console.error(err); }
  };
}

function processData(d) {
  roll = d.roll || 0;
  pitch = d.pitch || 0;
  
  accelXRaw = d.accelX || 0;
  accelYRaw = d.accelY || 0;
  accelZRaw = d.accelZ || 0;
  gyroXRaw = d.gyroX || 0;
  gyroYRaw = d.gyroY || 0;
  gyroZRaw = d.gyroZ || 0;
  
  accelXData.shift();
  accelXData.push(accelXRaw);
  accelYData.shift();
  accelYData.push(accelYRaw);
  accelZData.shift();
  accelZData.push(accelZRaw);
  gyroXData.shift();
  gyroXData.push(gyroXRaw);
  gyroYData.shift();
  gyroYData.push(gyroYRaw);
  gyroZData.shift();
  gyroZData.push(gyroZRaw);
  
  document.getElementById('rollVal').textContent = roll.toFixed(0) + '¬∞';
  document.getElementById('pitchVal').textContent = pitch.toFixed(0) + '¬∞';
  document.getElementById('accelVal').textContent = (d.accelMag || 1).toFixed(2);
  
  if (demoActive) {
    checkDemoProgress();
  }
  
  const rollFill = document.getElementById('rollFill');
  const pitchFill = document.getElementById('pitchFill');
  
  if (roll >= 0) {
    rollFill.style.left = '50%';
    rollFill.style.width = Math.min(roll, 50) + '%';
  } else {
    rollFill.style.left = (50 + roll) + '%';
    rollFill.style.width = Math.min(-roll, 50) + '%';
  }
  
  if (pitch >= 0) {
    pitchFill.style.left = '50%';
    pitchFill.style.width = Math.min(pitch, 50) + '%';
  } else {
    pitchFill.style.left = (50 + pitch) + '%';
    pitchFill.style.width = Math.min(-pitch, 50) + '%';
  }
  
  strumIntensity = Math.max(0, (d.accelMag || 1) - 1) * 100;
  document.getElementById('strumFill').style.width = Math.min(strumIntensity, 100) + '%';
  document.getElementById('strumVal').textContent = Math.round(strumIntensity) + '%';
  
  let activeCount = 0;
  const g = guitarTypes[currentGuitar];
  
  for (let i = 0; i < g.strings; i++) {
    const el = document.getElementById('s' + (g.strings - i));
    if (!el) continue;
    
    const wasActive = stringStates[i];
    stringStates[i] = d.strings ? d.strings[i] : false;
    
    if (stringStates[i]) {
      el.classList.add('active');
      activeCount++;
      if (!wasActive) stringVibration[i] = 1;
    } else {
      el.classList.remove('active');
    }
  }
  
  document.getElementById('activeCount').textContent = activeCount;
  document.getElementById('chordDisplay').textContent = d.chord || 'Open';
  
  if (d.strum && d.playFreqs) {
    strumCount++;
    document.getElementById('strumCount').textContent = strumCount;
    
    const chordEl = document.getElementById('chordDisplay');
    chordEl.classList.add('strumming');
    setTimeout(() => chordEl.classList.remove('strumming'), 150);
    
    for (let i = 0; i < g.strings; i++) {
      if (stringStates[i]) {
        stringVibration[i] = 1;
      }
    }
    
    if (audioEnabled && d.playFreqs) {
      d.playFreqs.forEach((freq) => {
        if (freq > 0) {
          playNote(freq, g.waveform);
          noteCount++;
        }
      });
      document.getElementById('noteCount').textContent = noteCount;
    }
  }
}

function toggleAudio() {
  const btn = document.getElementById('audioBtn');
  
  if (!audioEnabled) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    audioEnabled = true;
    btn.innerHTML = '<span>üîá</span> Sound Enabled';
    btn.classList.add('active');
    document.getElementById('audioDot').className = 'dot green';
    document.getElementById('audioStatus').textContent = 'Audio On';
    playNote(440, 'sine', 0.2);
  } else {
    audioEnabled = false;
    btn.innerHTML = '<span>üîä</span> TAP TO ENABLE SOUND';
    btn.classList.remove('active');
    document.getElementById('audioDot').className = 'dot yellow';
    document.getElementById('audioStatus').textContent = 'Audio Off';
  }
}

function playNote(freq, waveform = 'triangle', duration = 0.6) {
  if (!audioCtx) return;
  
  const now = audioCtx.currentTime;
  const g = guitarTypes[currentGuitar];
  
  const osc1 = audioCtx.createOscillator();
  const osc2 = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  
  osc1.type = waveform;
  osc1.frequency.setValueAtTime(freq, now);
  
  osc2.type = 'sine';
  osc2.frequency.setValueAtTime(freq * 2, now);
  
  const gain2 = audioCtx.createGain();
  gain2.gain.setValueAtTime(0.15, now);
  
  let attack = 0.01, decay = 0.1, sustain = 0.7, release = duration;
  
  if (g.name === 'Electric') {
    attack = 0.005; decay = 0.05; sustain = 0.8; release = duration * 1.2;
  } else if (g.name === 'Classical') {
    attack = 0.02; decay = 0.15; sustain = 0.5; release = duration * 0.8;
  } else if (g.name === 'Bass') {
    attack = 0.01; decay = 0.2; sustain = 0.6; release = duration * 1.5;
  } else if (g.name === 'Ukulele') {
    attack = 0.005; decay = 0.08; sustain = 0.4; release = duration * 0.5;
  }
  
  const maxGain = 0.2 * sensitivity;
  gain.gain.setValueAtTime(0, now);
  gain.gain.linearRampToValueAtTime(maxGain, now + attack);
  gain.gain.linearRampToValueAtTime(maxGain * sustain, now + attack + decay);
  gain.gain.linearRampToValueAtTime(maxGain * sustain * 0.8, now + release * 0.7);
  gain.gain.linearRampToValueAtTime(0, now + release);
  
  osc1.connect(gain);
  osc2.connect(gain2);
  gain2.connect(gain);
  gain.connect(audioCtx.destination);
  
  osc1.start(now);
  osc2.start(now);
  osc1.stop(now + release + 0.1);
  osc2.stop(now + release + 0.1);
}

function setSensitivity(val) {
  sensitivity = val / 100;
  document.getElementById('sensVal').textContent = val;
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({sensitivity: sensitivity}));
  }
}

function toggleDemo() {
  demoActive = !demoActive;
  const btn = document.getElementById('demoBtn');
  const stepsDiv = document.getElementById('demoSteps');
  
  if (demoActive) {
    btn.innerHTML = '<span>‚è∏Ô∏è</span> Pause Tutorial';
    btn.classList.add('active');
    demoStep = 0;
    updateDemoInstruction();
    stepsDiv.style.display = 'block';
  } else {
    btn.innerHTML = '<span>‚ñ∂Ô∏è</span> Start Tutorial';
    btn.classList.remove('active');
    stepsDiv.style.display = 'none';
    document.getElementById('demoInstruction').textContent = 'Press "Start Tutorial" to learn how to play the air guitar!';
  }
}

function updateDemoInstruction() {
  if (demoStep < demoInstructions.length) {
    document.getElementById('demoInstruction').textContent = `Step ${demoStep + 1}/${demoInstructions.length}: ${demoInstructions[demoStep]}`;
  } else {
    document.getElementById('demoInstruction').textContent = 'üéâ Tutorial Complete! You\'re a pro now!';
    demoActive = false;
    document.getElementById('demoBtn').classList.remove('active');
  }
}

function skipDemoStep() {
  if (demoActive && demoStep < demoInstructions.length - 1) {
    demoStep++;
    updateDemoInstruction();
  }
}

function resetDemo() {
  demoStep = 0;
  demoActive = false;
  document.getElementById('demoBtn').innerHTML = '<span>‚ñ∂Ô∏è</span> Start Tutorial';
  document.getElementById('demoBtn').classList.remove('active');
  document.getElementById('demoSteps').style.display = 'none';
  document.getElementById('demoInstruction').textContent = 'Press "Start Tutorial" to learn how to play the air guitar!';
}

function checkDemoProgress() {
  if (!demoActive || demoStep >= demoInstructions.length) return;
  
  let advance = false;
  
  switch(demoStep) {
    case 0:
      if (Math.abs(pitch) < 30) advance = true;
      break;
    case 1:
      if (roll < -15) advance = true;
      break;
    case 2:
      if (roll > 15) advance = true;
      break;
    case 3:
      if (pitch > 20) advance = true;
      break;
    case 4:
      if (pitch < -20) advance = true;
      break;
    case 5:
      if (strumIntensity > 30) advance = true;
      break;
    case 6:
      if (Math.abs(roll) > 10 && strumIntensity > 20) advance = true;
      break;
    case 7:
      if (pitch > 20 && pitch < 35 && strumIntensity > 25) advance = true;
      break;
    case 8:
      if (pitch > 35 && strumIntensity > 30) advance = true;
      break;
  }
  
  if (advance) {
    setTimeout(() => {
      demoStep++;
      updateDemoInstruction();
    }, 500);
  }
}

function drawEngineeringGraph(canvasId, data, color, avgColor, label, unit, range) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const w = canvas.width;
  const h = canvas.height;
  
  ctx.clearRect(0, 0, w, h);
  
  ctx.strokeStyle = 'rgba(100,126,234,0.15)';
  ctx.lineWidth = 1;
  
  for (let i = 0; i <= 10; i++) {
    const y = (h / 10) * i;
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(w, y);
    ctx.stroke();
  }
  
  for (let i = 0; i <= 10; i++) {
    const x = (w / 10) * i;
    ctx.beginPath();
    ctx.moveTo(x, 0);
    ctx.lineTo(x, h);
    ctx.stroke();
  }
  
  ctx.strokeStyle = 'rgba(255,255,255,0.3)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, h / 2);
  ctx.lineTo(w, h / 2);
  ctx.stroke();
  
  ctx.fillStyle = 'rgba(255,255,255,0.5)';
  ctx.font = '10px monospace';
  ctx.textAlign = 'right';
  ctx.fillText(`+${range}${unit}`, w - 5, 15);
  ctx.fillText(`0${unit}`, w - 5, h / 2 + 4);
  ctx.fillText(`-${range}${unit}`, w - 5, h - 5);
  
  const avg = data.reduce((a, b) => a + b, 0) / data.length;
  
  const avgY = h / 2 - (avg / range) * (h / 2);
  ctx.strokeStyle = avgColor;
  ctx.lineWidth = 1;
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  ctx.moveTo(0, avgY);
  ctx.lineTo(w, avgY);
  ctx.stroke();
  ctx.setLineDash([]);
  
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.beginPath();
  
  for (let i = 0; i < data.length; i++) {
    const x = (i / (data.length - 1)) * w;
    const y = h / 2 - (data[i] / range) * (h / 2);
    
    if (i === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  }
  ctx.stroke();
  
  ctx.lineTo(w, h / 2);
  ctx.lineTo(0, h / 2);
  ctx.closePath();
  
  const gradient = ctx.createLinearGradient(0, 0, 0, h);
  gradient.addColorStop(0, color + '40');
  gradient.addColorStop(0.5, color + '10');
  gradient.addColorStop(1, color + '40');
  ctx.fillStyle = gradient;
  ctx.fill();
  
  const lastVal = data[data.length - 1];
  const lastY = h / 2 - (lastVal / range) * (h / 2);
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(w - 5, lastY, 4, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 12px monospace';
  ctx.textAlign = 'left';
  ctx.fillText(`${lastVal.toFixed(2)}${unit}`, 10, 20);
  ctx.font = '10px monospace';
  ctx.fillText(`Avg: ${avg.toFixed(2)}${unit}`, 10, 35);
  ctx.fillText(`Peak: ${Math.max(...data).toFixed(2)}${unit}`, 10, 50);
}

function updateAllGraphs() {
  drawEngineeringGraph('accelXGraph', accelXData, '#ff6b6b', '#ffaa00', 'Accel X', 'g', 2);
  drawEngineeringGraph('accelYGraph', accelYData, '#4ecdc4', '#00d4ff', 'Accel Y', 'g', 2);
  drawEngineeringGraph('accelZGraph', accelZData, '#a29bfe', '#d77fff', 'Accel Z', 'g', 2);
  drawEngineeringGraph('gyroXGraph', gyroXData, '#ff6b6b', '#ff9999', 'Gyro X', '¬∞/s', 250);
  drawEngineeringGraph('gyroYGraph', gyroYData, '#4ecdc4', '#7efff5', 'Gyro Y', '¬∞/s', 250);
  drawEngineeringGraph('gyroZGraph', gyroZData, '#a29bfe', '#c9bbff', 'Gyro Z', '¬∞/s', 250);
  
  requestAnimationFrame(updateAllGraphs);
}
)rawliteral";

const char webpage_part3[] PROGMEM = R"rawliteral(
const canvas = document.getElementById('guitarCanvas');
const ctx = canvas.getContext('2d');

function resize() {
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
}
resize();
window.addEventListener('resize', resize);

function drawGuitar() {
  const w = canvas.width, h = canvas.height;
  const cx = w / 2, cy = h / 2;
  const g = guitarTypes[currentGuitar];
  ctx.clearRect(0, 0, w, h);
  const scale = Math.min(w / 400, h / 600) * 0.85;
  ctx.save();
  ctx.translate(cx, cy);
  ctx.scale(scale, scale);
  switch(g.bodyShape) {
    case 'stratocaster':
      drawElectricGuitar(g);
      break;
    case 'precision':
      drawBassGuitar(g);
      break;
    case 'ukulele':
      drawUkulele(g);
      break;
    case 'classical':
      drawClassicalGuitar(g);
      break;
    default:
      drawAcousticGuitar(g);
  }
  ctx.restore();
  frameCount++;
  requestAnimationFrame(drawGuitar);
}

function drawAcousticGuitar(g) {
  ctx.save();
  ctx.shadowColor = 'rgba(0,0,0,0.5)';
  ctx.shadowBlur = 20;
  ctx.shadowOffsetX = 10;
  ctx.shadowOffsetY = 15;
  ctx.fillStyle = 'rgba(0,0,0,0.1)';
  ctx.beginPath();
  ctx.ellipse(0, 40, 90, 115, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();
  const bodyGrad = ctx.createRadialGradient(-30, -10, 20, 0, 40, 140);
  bodyGrad.addColorStop(0, '#b8956a');
  bodyGrad.addColorStop(0.3, g.bodyColor);
  bodyGrad.addColorStop(0.7, g.bodyColor2);
  bodyGrad.addColorStop(1, '#6b5639');
  ctx.fillStyle = bodyGrad;
  ctx.beginPath();
  ctx.ellipse(0, 40, 90, 115, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = 'rgba(90,60,30,0.15)';
  ctx.lineWidth = 1;
  for (let i = 0; i < 8; i++) {
    ctx.beginPath();
    ctx.ellipse(0, 40, 88 - i * 3, 113 - i * 4, 0, 0, Math.PI * 2);
    ctx.stroke();
  }
  ctx.strokeStyle = '#F5DEB3';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.ellipse(0, 40, 90, 115, 0, 0, Math.PI * 2);
  ctx.stroke();
  ctx.strokeStyle = '#8B4513';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.ellipse(0, 40, 87, 112, 0, 0, Math.PI * 2);
  ctx.stroke();
  const highlight = ctx.createLinearGradient(-50, -20, 50, 100);
  highlight.addColorStop(0, 'rgba(255,255,200,0.3)');
  highlight.addColorStop(0.5, 'rgba(255,255,200,0.05)');
  highlight.addColorStop(1, 'rgba(255,255,200,0)');
  ctx.fillStyle = highlight;
  ctx.beginPath();
  ctx.ellipse(0, 40, 90, 115, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#000';
  ctx.beginPath();
  ctx.ellipse(0, 45, 38, 42, 0, 0, Math.PI * 2);
  ctx.fill();
  const holeGrad = ctx.createRadialGradient(0, 45, 30, 0, 45, 42);
  holeGrad.addColorStop(0, 'rgba(0,0,0,0.9)');
  holeGrad.addColorStop(1, 'rgba(50,30,20,0.8)');
  ctx.fillStyle = holeGrad;
  ctx.fill();
  const rosetteColors = ['#DAA520', '#8B4513', '#DEB887', '#8B6914', '#DAA520'];
  rosetteColors.forEach((color, i) => {
    ctx.strokeStyle = color;
    ctx.lineWidth = i % 2 === 0 ? 3 : 2;
    ctx.beginPath();
    ctx.ellipse(0, 45, 42 + i * 4, 46 + i * 4, 0, 0, Math.PI * 2);
    ctx.stroke();
  });
  ctx.strokeStyle = '#8B4513';
  ctx.lineWidth = 1;
  for (let i = 0; i < 12; i++) {
    const angle = (i / 12) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(Math.cos(angle) * 42, 45 + Math.sin(angle) * 46);
    ctx.lineTo(Math.cos(angle) * 50, 45 + Math.sin(angle) * 54);
    ctx.stroke();
  }
  const neckGrad = ctx.createLinearGradient(-18, 0, 18, 0);
  neckGrad.addColorStop(0, '#5a4028');
  neckGrad.addColorStop(0.1, g.neckColor);
  neckGrad.addColorStop(0.5, '#7a5838');
  neckGrad.addColorStop(0.9, g.neckColor);
  neckGrad.addColorStop(1, '#5a4028');
  ctx.fillStyle = neckGrad;
  ctx.fillRect(-18, -200, 36, 170);
  const fretGrad = ctx.createLinearGradient(-15, 0, 15, 0);
  fretGrad.addColorStop(0, '#0a0a0a');
  fretGrad.addColorStop(0.5, '#1a1a1a');
  fretGrad.addColorStop(1, '#0a0a0a');
  ctx.fillStyle = fretGrad;
  ctx.fillRect(-15, -200, 30, 170);
  ctx.strokeStyle = '#c0c0c0';
  ctx.shadowColor = 'rgba(0,0,0,0.5)';
  ctx.shadowBlur = 2;
  for (let i = 0; i < 7; i++) {
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    const y = -180 + i * 25;
    const width = 15 + i * 0.5;
    ctx.moveTo(-width, y);
    ctx.lineTo(width, y);
    ctx.stroke();
    ctx.strokeStyle = 'rgba(0,0,0,0.3)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(-width, y + 1);
    ctx.lineTo(width, y + 1);
    ctx.stroke();
    ctx.strokeStyle = '#c0c0c0';
  }
  ctx.shadowBlur = 0;
  ctx.fill(); 
  drawStrings(g);
}

function drawStrings(g) {
  const startY = -200;
  const endY = 100;
  
  for(let i=0; i<g.strings; i++) {
    const x = -15 + (i * (30 / (g.strings - 1)));
    ctx.strokeStyle = 'rgba(200,200,200,0.8)';
    ctx.lineWidth = 1 + (g.strings-i)*0.2;
    ctx.beginPath();
)rawliteral";

const char webpage_part4[] PROGMEM = R"rawliteral(
    ctx.moveTo(x, startY);
    
    for (let y = startY; y <= endY; y += 4) {
      const progress = (y - startY) / (endY - startY);
      const envelope = Math.sin(progress * Math.PI);
      const vib = Math.sin(Date.now() * vibSpeed + y * 0.02 + i * 0.5) * vibAmp * envelope;
      ctx.lineTo(x + vib, y);
    }
    ctx.stroke();
    
    if (stringVibration[i] > 0) {
      stringVibration[i] *= 0.96;
      if (stringVibration[i] < 0.01) stringVibration[i] = 0;
    }
  }
}

function updateFps() {
  const now = Date.now();
  if (now - lastFpsTime >= 1000) {
    document.getElementById('fps').textContent = frameCount;
    frameCount = 0;
    lastFpsTime = now;
  }
  setTimeout(updateFps, 100);
}

function resizeGraphs() {
  const graphs = ['accelXGraph', 'accelYGraph', 'accelZGraph', 'gyroXGraph', 'gyroYGraph', 'gyroZGraph'];
  graphs.forEach(id => {
    const canvas = document.getElementById(id);
    if (canvas) {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    }
  });
}

connectWS();
drawGuitar();
updateFps();
resizeGraphs();
updateAllGraphs();
window.addEventListener('resize', () => {
  resize();
  resizeGraphs();
});
</script>
</body>
</html>
)rawliteral";

void webSocketEvent(uint8_t num, WStype_t type, uint8_t* payload, size_t length) {
  if (type == WStype_TEXT) {
    String msg = String((char*)payload);
    if (msg.indexOf("guitarType") > 0) {
      int idx = msg.indexOf(":");
      if (idx > 0) {
        int type = msg.substring(idx + 1).toInt();
        currentGuitarType = constrain(type, 0, 4);
        stringCount = (currentGuitarType == 3 || currentGuitarType == 4) ? 4 : 6;
        Serial.printf("üé∏ Guitar changed to type %d (%d strings)\n", currentGuitarType, stringCount);
      }
    }
    if (msg.indexOf("sensitivity") > 0) {
      int idx = msg.indexOf(":");
      if (idx > 0) {
        sensitivity = msg.substring(idx + 1).toFloat();
        Serial.printf("üéöÔ∏è Sensitivity: %.2f\n", sensitivity);
      }
    }
  }
}

void setup() {
  Serial.begin(115200);
  delay(500);
  
  Serial.println("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  Serial.println("‚ïë   Electric Brain - ESP32 Guitar v5.0      ‚ïë");
  Serial.println("‚ïë   Acoustic | Electric | Classical        ‚ïë");
  Serial.println("‚ïë   Bass | Ukulele                         ‚ïë");
  Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n");
  
  // FIX: Updated for ESP32 Core 3.0+
  // ledcSetup and ledcAttachPin are REMOVED in version 3.0
  // Replaced with single ledcAttach(pin, freq, res)
  ledcAttach(BUZZER_PIN, 1000, 8);
  
  Wire.begin(I2C_SDA, I2C_SCL);
  Wire.setClock(400000);
  
  int err = mpu.init(calib, IMU_ADDRESS);
  if (err != 0) {
    Serial.printf("‚úó MPU6500 failed: %d\n", err);
    while (1) delay(1000);
  }
  Serial.println("‚úì MPU6500 OK");
  mpu.setAccelRange(4);
  mpu.setGyroRange(500);
  
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  Serial.print("‚è≥ WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    Serial.print(".");
  }
  Serial.printf("\n‚úì Connected! Open: http://%s\n", WiFi.localIP().toString().c_str());
  
  webSocket.begin();
  webSocket.onEvent(webSocketEvent);
  
  server.on("/", []() {
    String fullPage = String(webpage) + String(webpage_part2) + String(webpage_part3) + String(webpage_part4);
    server.send(200, "text/html", fullPage);
  });
  server.begin();
  
  Serial.println("\nüé∏ Ready! Select guitar type in browser");
  Serial.println("   Tilt to select strings, shake to strum!\n");
}

void loop() {
  webSocket.loop();
  server.handleClient();
  
  unsigned long now = millis();
  
  if (now - lastSensorUpdate >= 8) {
    lastSensorUpdate = now;
    updateSensor();
  }
  
  if (now - lastBroadcast >= 25) {
    lastBroadcast = now;
    broadcastData();
  }
}

void updateSensor() {
  mpu.update();
  mpu.getAccel(&accelData);
  mpu.getGyro(&gyroData);
  
  accelX = accelData.accelX;
  accelY = accelData.accelY;
  accelZ = accelData.accelZ;
  gyroX = gyroData.gyroX;
  gyroY = gyroData.gyroY;
  gyroZ = gyroData.gyroZ;
  
  roll = atan2(accelX, accelZ) * 180.0 / PI;
  pitch = atan2(accelY, sqrt(accelX * accelX + accelZ * accelZ)) * 180.0 / PI;
  
  accelMag = sqrt(accelX * accelX + accelY * accelY + accelZ * accelZ);
  gyroMag = sqrt(gyroX * gyroX + gyroY * gyroY + gyroZ * gyroZ);
  
  updateStringSelection();
  detectChord();
}

void updateStringSelection() {
  for (int i = 0; i < 6; i++) {
    stringActive[i] = false;
    stringVelocity[i] = 0;
  }
  
  activeStringCount = 0;
  
  float rollRange = (stringCount == 4) ? 30.0 : 45.0;
  float normalizedRoll = constrain(roll, -rollRange, rollRange);
  
  float stringFloat = ((normalizedRoll + rollRange) / (2 * rollRange)) * (stringCount - 1);
  int centerString = constrain((int)round(stringFloat), 0, stringCount - 1);
  
  stringActive[centerString] = true;
  stringVelocity[centerString] = 1.0;
  activeStringCount = 1;
  
  float rollMag = abs(roll);
  
  if (rollMag > 15) {
    if (roll < 0 && centerString > 0) {
      stringActive[centerString - 1] = true;
      stringVelocity[centerString - 1] = 0.8;
      activeStringCount++;
    }
    if (roll > 0 && centerString < stringCount - 1) {
      stringActive[centerString + 1] = true;
      stringVelocity[centerString + 1] = 0.8;
      activeStringCount++;
    }
  }
  
  if (rollMag > 30) {
    for (int i = 0; i < stringCount; i++) {
      if (!stringActive[i]) {
        int dist = abs(i - centerString);
        if (dist <= 2) {
          stringActive[i] = true;
          stringVelocity[i] = 1.0 - (dist * 0.2);
          activeStringCount++;
        }
      }
    }
  }
  
  if (rollMag > 40) {
    for (int i = 0; i < stringCount; i++) {
      stringActive[i] = true;
      stringVelocity[i] = 1.0 - (abs(i - centerString) * 0.1);
    }
    activeStringCount = stringCount;
  }
}

void detectChord() {
  unsigned long now = millis();
  if (now - lastChordChange < 150) return;
  
  String newChord = currentChord;
  int newIdx = currentChordIndex;
  
  if (pitch > 35) {
    newChord = "G"; newIdx = 2;
  } else if (pitch < -35) {
    newChord = "D"; newIdx = 3;
  } else if (pitch > 20) {
    newChord = "C"; newIdx = 1;
  } else if (pitch < -20) {
    newChord = "Am"; newIdx = 5;
  } else if (abs(roll) > 35) {
    newChord = "Em"; newIdx = 4;
  } else if (abs(pitch) < 10 && abs(roll) < 10) {
    newChord = "Open"; newIdx = 0;
  } else {
    newChord = "Dm"; newIdx = 6;
  }
  
  if (newChord != currentChord) {
    currentChord = newChord;
    currentChordIndex = newIdx;
    lastChordChange = now;
  }
}

void broadcastData() {
  unsigned long now = millis();
  
  float accelChange = abs(accelMag - lastAccelMag);
  lastAccelMag = accelMag;
  
  bool strum = false;
  
  if (accelMag > 1.0 + STRUM_THRESHOLD * sensitivity) strum = true;
  if (accelChange > STRUM_THRESHOLD * 0.4 * sensitivity) strum = true;
  if (gyroMag > GYRO_THRESHOLD * sensitivity) strum = true;
  
  if (strum && (now - lastStrumTime < STRUM_COOLDOWN)) {
    strum = false;
  }
  
  if (strum) {
    lastStrumTime = now;
    wasStrumming = true;
  } else if (accelMag < 1.0 + STRUM_THRESHOLD * 0.3) {
    wasStrumming = false;
  }
  
  String json = "{";
  json += "\"roll\":" + String(roll, 1) + ",";
  json += "\"pitch\":" + String(pitch, 1) + ",";
  json += "\"accelMag\":" + String(accelMag, 2) + ",";
  json += "\"gyroMag\":" + String(gyroMag, 1) + ",";
  json += "\"accelX\":" + String(accelX, 3) + ",";
  json += "\"accelY\":" + String(accelY, 3) + ",";
  json += "\"accelZ\":" + String(accelZ, 3) + ",";
  json += "\"gyroX\":" + String(gyroX, 2) + ",";
  json += "\"gyroY\":" + String(gyroY, 2) + ",";
  json += "\"gyroZ\":" + String(gyroZ, 2) + ",";
  json += "\"chord\":\"" + currentChord + "\",";
  
  json += "\"strings\":[";
  for (int i = 0; i < 6; i++) {
    json += (i < stringCount && stringActive[i]) ? "true" : "false";
    if (i < 5) json += ",";
  }
  json += "],";
  
  json += "\"strum\":" + String(strum ? "true" : "false");
  
  if (strum) {
    json += ",\"playFreqs\":[";
    
    for (int i = 0; i < stringCount; i++) {
      if (stringActive[i]) {
        float baseFreq = tunings[currentGuitarType][i];
        int fret = chordFrets[currentChordIndex][i];
        
        if (fret >= 0) {
          float freq = baseFreq * pow(1.059463, fret);
          json += String(freq, 2);
        } else {
          json += "0";
        }
      } else {
        json += "0";
      }
      if (i < stringCount - 1) json += ",";
    }
    json += "]";
    
    for (int i = stringCount - 1; i >= 0; i--) {
      if (stringActive[i]) {
        float freq = tunings[currentGuitarType][i] * pow(1.059463, chordFrets[currentChordIndex][i]);
        // FIX: Updated for ESP32 Core 3.0+
        // Uses ledcWriteTone(pin, freq) instead of channel
        ledcWriteTone(BUZZER_PIN, (int)freq);
        delay(30);
        ledcWriteTone(BUZZER_PIN, 0);
        break;
      }
    }
  }
  
  json += "}";
  
  webSocket.broadcastTXT(json);
}
